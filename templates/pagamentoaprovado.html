<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Empresa e Usuário</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <link rel="icon" href="/static/img/logo fav icon.png" type="image/png">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
        }

        .main-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .form-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
            max-width: 600px;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .form-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .header-section {
            text-align: center;
            margin-bottom: 30px;
        }

        .header-section h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-section h4 {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 20px;
            font-weight: 400;
        }

        .header-section h3 {
            font-size: 1.8rem;
            color: #333;
            font-weight: 600;
            margin-bottom: 30px;
        }

        .plan-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 8px 20px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .form-section {
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 25px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.95rem;
        }

        .form-control {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #fff;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        .form-control.error {
            border-color: #dc3545;
            background-color: #fff8f8;
        }

        .form-control.success {
            border-color: #28a745;
        }

        .document-container {
            display: flex;
            gap: 15px;
            align-items: end;
        }

        .document-type {
            flex: 0 0 120px;
        }

        .document-type select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 1rem;
            background: #fff;
        }

        .document-input {
            flex: 1;
        }

        .address-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .password-container {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #666;
            transition: color 0.3s ease;
        }

        .password-toggle:hover {
            color: #667eea;
        }

        .password-requirements {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
            border-left: 4px solid #667eea;
        }

        .password-requirements h5 {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .requirement-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .requirement-list li {
            padding: 3px 0;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .requirement-list li.valid {
            color: #28a745;
        }

        .requirement-list li.invalid {
            color: #dc3545;
        }

        .requirement-list li i {
            font-size: 0.8rem;
        }

        .btn-submit {
            width: 100%;
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-submit:active {
            transform: translateY(0);
        }

        .error-message {
            background: #ffe6e6;
            border: 1px solid #dc3545;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            color: #dc3545;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .field-error {
            color: #dc3545;
            font-size: 0.8rem;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .field-error.show {
            opacity: 1;
            transform: translateY(0);
        }

        .success-message {
            background: #e6ffe6;
            border: 1px solid #28a745;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            color: #28a745;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 10px;
            }

            .form-container {
                padding: 30px 20px;
            }

            .header-section h1 {
                font-size: 2rem;
            }

            .address-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .document-container {
                flex-direction: column;
                gap: 10px;
            }

            .document-type {
                flex: none;
            }
        }

        @media (max-width: 480px) {
            .form-container {
                padding: 20px 15px;
            }

            .header-section h1 {
                font-size: 1.8rem;
            }

            .header-section h3 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="main-container">
        <div class="form-container">
            <div class="header-section">
                <div class="plan-badge">
                    <i class="bi bi-calendar-check"></i>
                    Plano {{plano}} Dias
                </div>
                <h1>Sua Agenda</h1>
                <h4>Preencha as suas informações abaixo para começar a usar a sua agenda!</h4>
                <h3>Cadastro</h3>
            </div>

            <!-- Sistema de mensagens de erro do servidor -->
            <div id="server-errors">
                {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                {% for category, message in messages %}
                <div class="error-message">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    {% if 'duplicate key' in message %}
                        Este e-mail já está cadastrado. Por favor, use outro e-mail.
                    {% else %}
                        {{ message }}
                    {% endif %}
                </div>
                {% endfor %}
                {% endif %}
                {% endwith %}
            </div>

            <!-- Formulário de Cadastro da Empresa -->
            <div id="empresa-form-container" {% if empresa_cadastrada %}style="display: none;"{% endif %}>
                <form method="POST" action="/pagamentoaprovado/{{ plano }}" id="empresaForm">
                    <input type="hidden" name="plano" value="{{ plano }}">

                    <div class="form-section">
                        <div class="form-group">
                            <label for="nome_empresa">
                                <i class="bi bi-building"></i>
                                Nome da Empresa
                            </label>
                            <input type="text" id="nome_empresa" name="nome_empresa" class="form-control" required placeholder="Digite o nome da sua empresa" minlength="3" maxlength="100">
                            <div class="field-error" id="nome_empresa-error">
                                <i class="bi bi-exclamation-circle"></i>
                                <span></span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="tipo_documento">
                                <i class="bi bi-card-text"></i>
                                Tipo de Documento
                            </label>
                            <div class="document-container">
                                <div class="document-type">
                                    <select id="tipo_documento" name="tipo_documento">
                                        <option value="cpf">CPF</option>
                                        <option value="cnpj">CNPJ</option>
                                    </select>
                                </div>
                                <div class="document-input">
                                    <input type="text" id="cnpj" name="cnpj" class="form-control" required placeholder="Digite o documento">
                                    <div class="field-error" id="cnpj-error">
                                        <i class="bi bi-exclamation-circle"></i>
                                        <span></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="email">
                                <i class="bi bi-envelope"></i>
                                E-mail
                            </label>
                            <input type="email" id="email" name="email" class="form-control" required placeholder="sua@empresa.com">
                            <div class="field-error" id="email-error">
                                <i class="bi bi-exclamation-circle"></i>
                                <span></span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="descricao">
                                <i class="bi bi-chat-quote"></i>
                                Descrição
                            </label>
                            <textarea id="descricao" name="descricao" class="form-control" rows="3" required maxlength="30" placeholder="Descreva brevemente sua empresa"></textarea>
                            <div class="field-error" id="descricao-error">
                                <i class="bi bi-exclamation-circle"></i>
                                <span></span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="setor">
                                <i class="bi bi-briefcase"></i>
                                Setor
                            </label>
                            <select id="setor" name="setor" class="form-control" required>
                                <option value="">Selecione um setor</option>
                                <option value="Tecnologia">Tecnologia</option>
                                <option value="Beleza">Beleza</option>
                                <option value="Barbearia">Barbearia</option>
                                <option value="Saude">Saúde</option>
                                <option value="Outro">Outro</option>
                            </select>
                            <div class="field-error" id="setor-error">
                                <i class="bi bi-exclamation-circle"></i>
                                <span></span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="tel_empresa">
                                <i class="bi bi-telephone"></i>
                                Telefone
                            </label>
                            <input type="text" id="tel_empresa" name="tel_empresa" class="form-control" required placeholder="(00) 00000-0000">
                            <div class="field-error" id="tel_empresa-error">
                                <i class="bi bi-exclamation-circle"></i>
                                <span></span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>
                                <i class="bi bi-geo-alt"></i>
                                Localização
                            </label>
                            <div class="address-container">
                                <div>
                                    <input type="text" id="cidade" name="cidade" class="form-control" required placeholder="Cidade" minlength="3">
                                    <div class="field-error" id="cidade-error">
                                        <i class="bi bi-exclamation-circle"></i>
                                        <span></span>
                                    </div>
                                </div>
                                <div>
                                    <input type="text" id="cep" name="cep" class="form-control" required placeholder="CEP">
                                    <div class="field-error" id="cep-error">
                                        <i class="bi bi-exclamation-circle"></i>
                                        <span></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="endereco">
                                <i class="bi bi-house"></i>
                                Endereço
                            </label>
                            <input type="text" id="endereco" name="endereco" class="form-control" required placeholder="Rua, número, bairro" minlength="5">
                            <div class="field-error" id="endereco-error">
                                <i class="bi bi-exclamation-circle"></i>
                                <span></span>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn-submit">
                        <i class="bi bi-check-circle"></i>
                        Cadastrar Empresa
                    </button>
                </form>
            </div>

            <!-- Formulário de Cadastro do Primeiro Usuário -->
            <div id="usuario-form-container" {% if not empresa_cadastrada %}style="display: none;"{% endif %}>
                <form method="POST" action="/pagamentoaprovado/{{ plano }}" id="usuarioForm">
                    <input type="hidden" name="plano" value="{{ plano }}">
                    {% if empresa_cadastrada %}
                    <input type="hidden" name="empresa_id" value="{{ empresa_cadastrada.id }}">
                    {% endif %}

                    <div class="form-section">
                        <div class="form-group">
                            <label for="nome_usuario">
                                <i class="bi bi-person"></i>
                                Nome do Usuário
                            </label>
                            <input type="text" id="nome_usuario" name="nome_usuario" class="form-control" required placeholder="Digite seu nome completo" minlength="3" maxlength="100">
                            <div class="field-error" id="nome_usuario-error">
                                <i class="bi bi-exclamation-circle"></i>
                                <span></span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="email_usuario">
                                <i class="bi bi-envelope"></i>
                                E-mail
                            </label>
                            <input type="email" id="email_usuario" name="email_usuario" class="form-control" required placeholder="seu@email.com">
                            <div class="field-error" id="email_usuario-error">
                                <i class="bi bi-exclamation-circle"></i>
                                <span></span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="telefone">
                                <i class="bi bi-telephone"></i>
                                Telefone
                            </label>
                            <input type="text" id="telefone" name="telefone" class="form-control" required placeholder="(00) 00000-0000">
                            <div class="field-error" id="telefone-error">
                                <i class="bi bi-exclamation-circle"></i>
                                <span></span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="senha">
                                <i class="bi bi-lock"></i>
                                Senha
                            </label>
                            <div class="password-container">
                                <input type="password" id="senha" name="senha" class="form-control" required minlength="8" placeholder="Digite sua senha">
                                <button type="button" id="mostrarSenha" class="password-toggle">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                            <div class="password-requirements">
                                <h5>Requisitos da senha:</h5>
                                <ul class="requirement-list">
                                    <li id="req-tamanho">
                                        <i class="bi bi-circle"></i>
                                        Mínimo de 8 caracteres
                                    </li>
                                    <li id="req-maiuscula">
                                        <i class="bi bi-circle"></i>
                                        Pelo menos uma letra maiúscula
                                    </li>
                                    <li id="req-minuscula">
                                        <i class="bi bi-circle"></i>
                                        Pelo menos uma letra minúscula
                                    </li>
                                    <li id="req-numero">
                                        <i class="bi bi-circle"></i>
                                        Pelo menos um número
                                    </li>
                                </ul>
                            </div>
                            <div class="field-error" id="senha-error">
                                <i class="bi bi-exclamation-circle"></i>
                                <span></span>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn-submit">
                        <i class="bi bi-person-plus"></i>
                        Cadastrar Usuário
                    </button>
                </form>
            </div>
        </div>
    </div>
<script>
    window.erroEmpresaCadastrada = false;
</script>
<script>
        // Funções de validação e interação
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const errorDiv = document.getElementById(fieldId + '-error');
            const errorSpan = errorDiv.querySelector('span');
            
            field.classList.add('error');
            errorSpan.textContent = message;
            errorDiv.classList.add('show');
            
            // Limpa o erro quando o usuário começa a corrigir
            field.addEventListener('input', function() {
                this.classList.remove('error');
                errorDiv.classList.remove('show');
            }, { once: true });
        }

        function clearFieldErrors() {
            document.querySelectorAll('.form-control.error').forEach(field => {
                field.classList.remove('error');
            });
            document.querySelectorAll('.field-error.show').forEach(error => {
                error.classList.remove('show');
            });
        }

        function showSuccessMessage(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.innerHTML = `<i class="bi bi-check-circle-fill"></i>${message}`;
            
            const container = document.querySelector('.form-container');
            container.insertBefore(successDiv, container.firstChild);
            
            setTimeout(() => {
                successDiv.remove();
            }, 5000);
        }

        function showErrorMessage(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `<i class="bi bi-x-circle-fill"></i>${message}`;
            
            const container = document.querySelector('.form-container');
            container.insertBefore(errorDiv, container.firstChild);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        // Popup de erro para empresa já cadastrada
        function showEmpresaCadastradaPopup() {
            const overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.top = 0;
            overlay.style.left = 0;
            overlay.style.width = '100vw';
            overlay.style.height = '100vh';
            overlay.style.background = 'rgba(0,0,0,0.5)';
            overlay.style.display = 'flex';
            overlay.style.alignItems = 'center';
            overlay.style.justifyContent = 'center';
            overlay.style.zIndex = 99999;

            const popup = document.createElement('div');
            popup.style.background = '#fff';
            popup.style.borderRadius = '16px';
            popup.style.padding = '40px 30px';
            popup.style.maxWidth = '350px';
            popup.style.textAlign = 'center';
            popup.style.boxShadow = '0 8px 32px rgba(0,0,0,0.25)';
            popup.innerHTML = `
                <div style='font-size:48px; color:#dc3545; margin-bottom:16px;'><i class='bi bi-x-circle-fill'></i></div>
                <div style='font-size:20px; font-weight:600; margin-bottom:10px;'>Empresa já cadastrada</div>
                <div style='font-size:16px; color:#555; margin-bottom:24px;'>Já existe uma empresa com este e-mail ou documento.<br>Entre em contato para renovar seu plano ou tente novamente.</div>
                <button id='btnPopupEmpresaCadastrada' style='background:#dc3545; color:#fff; border:none; border-radius:8px; padding:10px 30px; font-size:16px; font-weight:600; cursor:pointer;'>OK</button>
            `;
            overlay.appendChild(popup);
            document.body.appendChild(overlay);
            document.getElementById('btnPopupEmpresaCadastrada').onclick = function() {
                document.body.removeChild(overlay);
                window.location.href = '/adquirir';
            };
        }

        // Inicialização quando o documento estiver pronto
        document.addEventListener('DOMContentLoaded', function() {
            // Máscaras para os campos
            $('#tel_empresa, #telefone').mask('(00) 00000-0000');
            $('#cep').mask('00000-000');
            
            // Máscara inicial como CPF
            $('#cnpj').mask('000.000.000-00');

            // Alternar entre máscaras de CPF e CNPJ
            $('#tipo_documento').on('change', function() {
                var tipo = $(this).val();
                var campo = $('#cnpj');
                campo.val(''); // Limpa o campo ao trocar
                if (tipo === 'cpf') {
                    campo.mask('000.000.000-00');
                    campo.attr('placeholder', 'Digite o CPF');
                } else {
                    campo.mask('00.000.000/0000-00');
                    campo.attr('placeholder', 'Digite o CNPJ');
                }
            });

            // Validação em tempo real da senha
            $('#senha').on('input', function() {
                validarSenha($(this).val());
            });

            // Botão para mostrar/ocultar senha
            $('#mostrarSenha').on('click', function() {
                const senhaInput = $('#senha');
                const icon = $(this).find('i');
                
                if (senhaInput.attr('type') === 'password') {
                    senhaInput.attr('type', 'text');
                    icon.removeClass('bi-eye').addClass('bi-eye-slash');
                } else {
                    senhaInput.attr('type', 'password');
                    icon.removeClass('bi-eye-slash').addClass('bi-eye');
                }
            });

            // Validação em tempo real dos campos
            $('.form-control').on('input', function() {
                this.classList.remove('error');
                const errorDiv = document.getElementById(this.id + '-error');
                if (errorDiv) {
                    errorDiv.classList.remove('show');
                }
            });

            // Validações específicas em tempo real
            $('#nome_empresa').on('input', function() {
                const nome = $(this).val().trim();
                if(nome.length < 3) {
                    showFieldError('nome_empresa', 'O nome da empresa deve ter pelo menos 3 caracteres');
                }
            });

            $('#descricao').on('input', function() {
                const desc = $(this).val().trim();
                if(desc.length === 0) {
                    showFieldError('descricao', 'A descrição é obrigatória');
                } else if(desc.length > 30) {
                    showFieldError('descricao', 'A descrição deve ter no máximo 30 caracteres');
                }
            });

            $('#setor').on('change', function() {
                if($(this).val() === '') {
                    showFieldError('setor', 'Selecione um setor');
                }
            });

            $('#cidade').on('input', function() {
                const cidade = $(this).val().trim();
                if(cidade.length < 3) {
                    showFieldError('cidade', 'Nome da cidade inválido');
                }
            });

            $('#endereco').on('input', function() {
                const endereco = $(this).val().trim();
                if(endereco.length < 5) {
                    showFieldError('endereco', 'Endereço inválido');
                }
            });

            // Exibir popup de erro se empresa já cadastrada
            if (window.erroEmpresaCadastrada === true) {
                showEmpresaCadastradaPopup();
            }
        });

        // Função para validar CPF
        function validarCPF(cpf) {
            cpf = cpf.replace(/[^\d]+/g,'');
            if(cpf.length !== 11) return false;
            
            // Validação do primeiro dígito
            let soma = 0;
            for(let i = 0; i < 9; i++) {
                soma += parseInt(cpf.charAt(i)) * (10 - i);
            }
            let resto = 11 - (soma % 11);
            let digitoVerificador1 = resto > 9 ? 0 : resto;
            if(digitoVerificador1 != cpf.charAt(9)) return false;

            // Validação do segundo dígito
            soma = 0;
            for(let i = 0; i < 10; i++) {
                soma += parseInt(cpf.charAt(i)) * (11 - i);
            }
            resto = 11 - (soma % 11);
            let digitoVerificador2 = resto > 9 ? 0 : resto;
            if(digitoVerificador2 != cpf.charAt(10)) return false;

            return true;
        }
        
        // Função para validar CNPJ
        function validarCNPJ(cnpj) {
            cnpj = cnpj.replace(/[^\d]+/g,'');
            if(cnpj.length !== 14) return false;

            // Validação do primeiro dígito
            let soma = 0;
            let multiplicador = 5;
            for(let i = 0; i < 12; i++) {
                soma += parseInt(cnpj.charAt(i)) * multiplicador;
                multiplicador = multiplicador === 2 ? 9 : multiplicador - 1;
            }
            let resto = soma % 11;
            let digitoVerificador1 = resto < 2 ? 0 : 11 - resto;
            if(digitoVerificador1 != cnpj.charAt(12)) return false;

            // Validação do segundo dígito
            soma = 0;
            multiplicador = 6;
            for(let i = 0; i < 13; i++) {
                soma += parseInt(cnpj.charAt(i)) * multiplicador;
                multiplicador = multiplicador === 2 ? 9 : multiplicador - 1;
            }
            resto = soma % 11;
            let digitoVerificador2 = resto < 2 ? 0 : 11 - resto;
            if(digitoVerificador2 != cnpj.charAt(13)) return false;

            return true;
        }

        function validarEmail(email) {
            const re = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            return re.test(email);
        }

        function validarSenha(senha) {
            const temTamanhoMinimo = senha.length >= 8;
            const temMaiuscula = /[A-Z]/.test(senha);
            const temMinuscula = /[a-z]/.test(senha);
            const temNumero = /[0-9]/.test(senha);

            // Atualiza o visual dos requisitos
            $('#req-tamanho').toggleClass('valid', temTamanhoMinimo).toggleClass('invalid', !temTamanhoMinimo)
                .find('i').toggleClass('bi-check-circle-fill', temTamanhoMinimo).toggleClass('bi-circle', !temTamanhoMinimo);
            
            $('#req-maiuscula').toggleClass('valid', temMaiuscula).toggleClass('invalid', !temMaiuscula)
                .find('i').toggleClass('bi-check-circle-fill', temMaiuscula).toggleClass('bi-circle', !temMaiuscula);
            
            $('#req-minuscula').toggleClass('valid', temMinuscula).toggleClass('invalid', !temMinuscula)
                .find('i').toggleClass('bi-check-circle-fill', temMinuscula).toggleClass('bi-circle', !temMinuscula);
            
            $('#req-numero').toggleClass('valid', temNumero).toggleClass('invalid', !temNumero)
                .find('i').toggleClass('bi-check-circle-fill', temNumero).toggleClass('bi-circle', !temNumero);

            return temTamanhoMinimo && temMaiuscula && temMinuscula && temNumero;
        }

        async function validarFormularioEmpresa() {
            clearFieldErrors();
            let hasErrors = false;

            // Validação do nome da empresa
            if($('#nome_empresa').val().trim().length < 3) {
                showFieldError('nome_empresa', 'O nome da empresa deve ter pelo menos 3 caracteres');
                hasErrors = true;
            }

            const cnpjCpf = $('#cnpj').val().replace(/[^\d]+/g,'');
            const tipoDocumento = $('#tipo_documento').val();
            
            // Validação do CNPJ/CPF
            if(tipoDocumento === 'cpf') {
                if(!validarCPF(cnpjCpf)) {
                    showFieldError('cnpj', 'CPF inválido');
                    hasErrors = true;
                }
            } else {
                if(!validarCNPJ(cnpjCpf)) {
                    showFieldError('cnpj', 'CNPJ inválido');
                    hasErrors = true;
                }
            }

            // Validação do e-mail
            const email = $('#email').val();
            if(!validarEmail(email)) {
                showFieldError('email', 'E-mail inválido');
                hasErrors = true;
            }

            // Validação da descrição
            const descricao = $('#descricao').val().trim();
            if(descricao.length === 0) {
                showFieldError('descricao', 'A descrição é obrigatória');
                hasErrors = true;
            } else if(descricao.length > 30) {
                showFieldError('descricao', 'A descrição deve ter no máximo 30 caracteres');
                hasErrors = true;
            }

            // Validação do setor
            if($('#setor').val() === '') {
                showFieldError('setor', 'Selecione um setor');
                hasErrors = true;
            }

            // Validação do telefone
            const telefone = $('#tel_empresa').val().replace(/[^\d]+/g,'');
            if(telefone.length !== 11) {
                showFieldError('tel_empresa', 'Telefone inválido');
                hasErrors = true;
            }

            // Validação da cidade
            if($('#cidade').val().trim().length < 3) {
                showFieldError('cidade', 'Nome da cidade inválido');
                hasErrors = true;
            }

            // Validação do CEP
            const cep = $('#cep').val().replace(/[^\d]+/g,'');
            if(cep.length !== 8) {
                showFieldError('cep', 'CEP inválido');
                hasErrors = true;
            }

            // Validação do endereço
            if($('#endereco').val().trim().length < 5) {
                showFieldError('endereco', 'Endereço inválido');
                hasErrors = true;
            }

            if(hasErrors) {
                return false;
            }

            // Verificar se empresa já existe antes de enviar
            try {
                showLoading();
                const response = await fetch('/api/verificar-empresa', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                        cnpj: cnpjCpf
                    })
                });

                const data = await response.json();
                
                if (data.existe) {
                    if (data.teste_ativo) {
                        showSuccessMessage('Empresa já cadastrada com teste ativo. Você pode continuar.');
                        hideLoading();
                        return true;
                    } else {
                        showFieldError('email', 'Empresa já cadastrada. Entre em contato para renovar seu plano.');
                        hideLoading();
                        return false;
                    }
                }
                
                hideLoading();
                return true;
            } catch (error) {
                console.error('Erro ao verificar empresa:', error);
                hideLoading();
                return true; // Permite continuar em caso de erro na verificação
            }
        }

        function validarFormularioUsuario() {
            clearFieldErrors();
            let hasErrors = false;

            // Validação do nome do usuário
            if($('#nome_usuario').val().trim().length < 3) {
                showFieldError('nome_usuario', 'O nome deve ter pelo menos 3 caracteres');
                hasErrors = true;
            }

            // Validação do e-mail
            if(!validarEmail($('#email_usuario').val())) {
                showFieldError('email_usuario', 'E-mail inválido');
                hasErrors = true;
            }

            // Validação do telefone
            const telefone = $('#telefone').val().replace(/[^\d]+/g,'');
            if(telefone.length !== 11) {
                showFieldError('telefone', 'Telefone inválido');
                hasErrors = true;
            }

            // Validação da senha
            const senha = $('#senha').val();
            if(!validarSenha(senha)) {
                showFieldError('senha', 'A senha não atende aos requisitos mínimos de segurança');
                hasErrors = true;
            }

            if(hasErrors) {
                return false;
            }

            showLoading();
            return true;
        }

        // Event listener para interceptar o submit do formulário de empresa
        document.addEventListener('DOMContentLoaded', function() {
            const empresaForm = document.getElementById('empresaForm');
            if (empresaForm) {
                empresaForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    // Validar formulário
                    const isValid = await validarFormularioEmpresa();
                    if (!isValid) {
                        return false;
                    }
                    
                    // Coletar dados do formulário
                    const formData = new FormData(this);
                    const dados = Object.fromEntries(formData.entries());
                    
                    try {
                        showLoading();
                        const response = await fetch(this.action, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(dados)
                        });
                        
                        const data = await response.json();
                        hideLoading();
                        
                        if (data.success) {
                            showSuccessMessage('Empresa cadastrada com sucesso! Agora cadastre o usuário responsável.');
                            // Ocultar formulário de empresa e mostrar formulário de usuário
                            document.getElementById('empresaForm').parentElement.style.display = 'none';
                            // Recarregar a página para mostrar o formulário de usuário
                            setTimeout(() => {
                                window.location.reload();
                            }, 2000);
                            // Armazenar ID da empresa para usar no cadastro do usuário
                            window.empresaId = data.empresa_id;
                        } else {
                            showErrorMessage(data.error || 'Erro ao cadastrar empresa.');
                        }
                    } catch (error) {
                        hideLoading();
                        console.error('Erro ao cadastrar empresa:', error);
                        showErrorMessage('Erro inesperado ao cadastrar empresa.');
                    }
                });
            }
            
            // Event listener para interceptar o submit do formulário de usuário
            const usuarioForm = document.getElementById('usuarioForm');
            if (usuarioForm) {
                usuarioForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    // Validar formulário
                    const isValid = validarFormularioUsuario();
                    if (!isValid) {
                        return false;
                    }
                    
                    // Coletar dados do formulário
                    const formData = new FormData(this);
                    const dados = Object.fromEntries(formData.entries());
                    
                    try {
                        showLoading();
                        const response = await fetch(this.action, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(dados)
                        });
                        
                        const data = await response.json();
                        hideLoading();
                        
                        if (data.success) {
                            showSuccessMessage('Usuário cadastrado com sucesso! Você pode fazer login agora.');
                            // Redirecionar para login após 2 segundos
                            setTimeout(() => {
                                window.location.href = '/login';
                            }, 2000);
                        } else {
                            showErrorMessage(data.error || 'Erro ao cadastrar usuário.');
                        }
                    } catch (error) {
                        hideLoading();
                        console.error('Erro ao cadastrar usuário:', error);
                        showErrorMessage('Erro inesperado ao cadastrar usuário.');
                    }
                });
            }
        });
    </script>
    <script src="/static/scripts/pagamento_aprovado.js"></script>
</body>

</html>
