{% extends "base.html" %}

{% block title %}Configurações - Sua Agenda{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="bi bi-gear-fill text-primary me-2"></i>
                    Configurações da Empresa
                </h1>
                <button type="submit" form="configForm" class="btn btn-primary">
                    <i class="bi bi-check-lg me-2"></i>
                    Salvar Alterações
                </button>
            </div>
        </div>
    </div>

    <form id="configForm" action="{{ url_for('config.atualizar_configuracao') }}" method="POST">
    
    <div class="row">
        <!-- Seção 1: Informações Básicas da Empresa -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-building me-2"></i>
                        Informações Básicas
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="nome_empresa" class="form-label">Nome da Empresa</label>
                        <input type="text" class="form-control" id="nome_empresa" name="nome_empresa" value="{{ empresa.nome_empresa if empresa.nome_empresa else '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="cnpj" class="form-label">CNPJ</label>
                        <input type="text" class="form-control" id="cnpj" name="cnpj" value="{{ empresa.cnpj if empresa.cnpj else '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="setor" class="form-label">Setor</label>
                        <input type="text" class="form-control" id="setor" name="setor" value="{{ empresa.setor if empresa.setor else '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="descricao" class="form-label">Descrição</label>
                        <textarea class="form-control" id="descricao" name="descricao" rows="3">{{ empresa.descricao if empresa.descricao else '' }}</textarea>
                    </div>
                    <div class="mb-3">
                        <label for="horario" class="form-label">Horário de Funcionamento</label>
                        <input type="text" class="form-control" id="horario" name="horario" value="{{ empresa.horario if empresa.horario else '' }}">
                    </div>
                </div>
            </div>
        </div>

        <!-- Seção 2: Contato e Endereço -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-geo-alt me-2"></i>
                        Contato e Localização
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="tel_empresa" class="form-label">Telefone</label>
                        <input type="tel" class="form-control" id="tel_empresa" name="tel_empresa" value="{{ empresa.tel_empresa if empresa.tel_empresa else '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="email_empresa" class="form-label">E-mail</label>
                        <input type="email" class="form-control" id="email_empresa" name="email_empresa" value="{{ empresa.email_empresa if empresa.email_empresa else '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="cep" class="form-label">CEP</label>
                        <input type="text" class="form-control" id="cep" name="cep" value="{{ empresa.cep if empresa.cep else '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="endereco" class="form-label">Endereço</label>
                        <input type="text" class="form-control" id="endereco" name="endereco" value="{{ empresa.endereco if empresa.endereco else '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="cidade" class="form-label">Cidade</label>
                        <input type="text" class="form-control" id="cidade" name="cidade" value="{{ empresa.cidade if empresa.cidade else '' }}">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Seção 3: Serviços e Comodidades -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-star me-2"></i>
                        Serviços e Comodidades
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="kids" name="kids" {% if empresa.kids %}checked{% endif %}>
                                <label class="form-check-label" for="kids">
                                    <i class="bi bi-emoji-smile text-warning me-1"></i>
                                    Kids
                                </label>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="estacionamento" name="estacionamento" {% if empresa.estacionamento %}checked{% endif %}>
                                <label class="form-check-label" for="estacionamento">
                                    <i class="bi bi-car-front text-primary me-1"></i>
                                    Estacionamento
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="wifi" name="wifi" {% if empresa.wifi %}checked{% endif %}>
                                <label class="form-check-label" for="wifi">
                                    <i class="bi bi-wifi text-info me-1"></i>
                                    Wi-Fi
                                </label>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="acessibilidade" name="acessibilidade" {% if empresa.acessibilidade %}checked{% endif %}>
                                <label class="form-check-label" for="acessibilidade">
                                    <i class="bi bi-universal-access text-success me-1"></i>
                                    Acessibilidade
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Seção 4: Personalização -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-palette me-2"></i>
                        Personalização
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="cor" class="form-label">Cor do Tema</label>
                        <div class="d-flex align-items-center">
                            <input type="color" class="form-control form-control-color me-3" id="cor" name="cor" value="{{ empresa.cor_emp if empresa.cor_emp else '#030413' }}" style="width: 60px; height: 40px;">
                            <div class="flex-grow-1">
                                <small class="text-muted">Escolha a cor principal da sua empresa para personalizar o sistema</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Seção 5: Link de Agendamento -->
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-link-45deg me-2"></i>
                        Link de Agendamento
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="url_agendamento" class="form-label">URL para compartilhar no WhatsApp</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="url_agendamento" readonly 
                                   value="https://www.suaagenda.fun/agendamento/{{ empresa.nome_empresa|lower|replace(' ', '-')|replace('_', '-') if empresa.nome_empresa else 'sua-empresa' }}">
                            <button class="btn btn-outline-secondary" type="button" onclick="copiarUrlAgendamento()">
                                <i class="bi bi-clipboard"></i> Copiar
                            </button>
                        </div>
                        <small class="form-text text-muted">
                            <i class="bi bi-whatsapp text-success me-1"></i>
                            Use este link em mensagens rápidas do WhatsApp para que clientes possam agendar diretamente
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Seção 6: Configurações WhatsApp -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-whatsapp me-2"></i>
                        WhatsApp CRM
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Status da Conexão</label>
                        <div id="whatsapp-status" class="form-control bg-light">
                            <span id="status-text">Verificando...</span>
                            <span id="status-indicator" class="badge ms-2"></span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <button type="button" id="btn-conectar-whatsapp" class="btn btn-success me-2">
                            <i class="bi bi-whatsapp"></i> Conectar WhatsApp
                        </button>
                        <button type="button" id="btn-desconectar-whatsapp" class="btn btn-danger me-2" style="display: none;">
                            <i class="bi bi-x-circle"></i> Desconectar
                        </button>
                        <button type="button" id="btn-limpar-conexoes" class="btn btn-warning me-2">
                            <i class="bi bi-arrow-clockwise"></i> Limpar Conexões
                        </button>
                        <a href="/whatsapp" class="btn btn-primary">
                            <i class="bi bi-chat-dots"></i> Abrir CRM
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Seção 7: Informações da Assinatura -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-credit-card me-2"></i>
                        Informações da Assinatura
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Dias Restantes</label>
                        <div id="dias-restantes" class="form-control bg-light">{{ empresa.dias_restantes if empresa.dias_restantes is not none else 'Carregando...' }}</div>
                    </div>
                    <a href="/planos-renovacao" class="btn btn-success btn-lg w-100 mt-2" style="font-size: 1.2rem;">
                        <i class="bi bi-arrow-repeat"></i> Renovar Plano
                    </a>
                </div>
            </div>
        </div>
    </div>

    </form>
        
        <!-- Modal QR Code -->
        <div class="modal fade" id="modalQrCode" tabindex="-1" aria-labelledby="modalQrCodeLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalQrCodeLabel">
                            <i class="bi bi-whatsapp text-success"></i> Conectar WhatsApp
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                    </div>
                    <div class="modal-body text-center">
                        <p class="mb-3">Escaneie o QR Code com seu WhatsApp:</p>
                        <div id="qr-code-container" class="mb-3">
                            <div id="qr-loading" class="spinner-border text-success" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                            <div id="qr-code-display" style="display: none;"></div>
                        </div>
                        <div id="qr-instructions" class="alert alert-info">
                            <small>
                                <strong>Instruções:</strong><br>
                                1. Abra o WhatsApp no seu celular<br>
                                2. Toque em Menu > Dispositivos conectados<br>
                                3. Toque em "Conectar um dispositivo"<br>
                                4. Escaneie o QR Code acima
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                        <button type="button" id="btn-refresh-qr" class="btn btn-primary">
                            <i class="bi bi-arrow-clockwise"></i> Atualizar QR Code
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Informações da Assinatura -->
    <!-- <div class="mb-4">
        <h4>Informações da Assinatura:</h4>
        <div class="mb-3">
            <label class="form-label">Dias Restantes</label>
            <div id="dias-restantes" class="form-control bg-light">{{ empresa.dias_restantes if empresa.dias_restantes is not none else 'Carregando...' }}</div>
        </div>
        <a href="/planos-renovacao" class="btn btn-success btn-lg w-100 mt-2" style="font-size: 1.2rem;">
            <i class="bi bi-arrow-repeat"></i> Renovar Plano
        </a>
    </div> -->

</div>
{% endblock %}

{% block page_scripts %}
<script>
// Configurações da API WhatsApp
// Detectar se está em produção ou desenvolvimento
const currentHost = window.location.hostname;
const isProduction = currentHost === 'www.suaagenda.fun' || currentHost === 'suaagenda.fun';

// FORÇAR USO DA API DE PRODUÇÃO PARA TESTES (desativado)
const FORCE_PRODUCTION_API = false;

const WHATSAPP_API_URL = (isProduction || FORCE_PRODUCTION_API) ? 'https://api.suaagenda.fun' : `{{ config.WHATSAPP_API_URL }}`;

console.log('🌐 Host atual:', currentHost);
console.log('🏭 Ambiente:', isProduction ? 'PRODUÇÃO' : 'DESENVOLVIMENTO');
console.log('🔧 Forçar API de produção:', FORCE_PRODUCTION_API);
console.log('🔗 URL da API WhatsApp:', WHATSAPP_API_URL);

// Garantir que o valor da cor esteja no formato correto
document.addEventListener('DOMContentLoaded', function() {
    const corInput = document.getElementById('cor');
    
    // Garante que o valor inicial esteja no formato correto
    if (corInput.value && !corInput.value.startsWith('#')) {
        corInput.value = '#' + corInput.value;
    }

    // Atualiza o valor quando o usuário seleciona uma cor
    corInput.addEventListener('change', function() {
        let cor = this.value;
        // Garante que a cor esteja no formato hexadecimal correto
        if (cor && !cor.startsWith('#')) {
            cor = '#' + cor;
        }
        this.value = cor;
    });

    // ============= WHATSAPP CONFIGURAÇÕES =============
    
    // Elementos do DOM
    const btnConectar = document.getElementById('btn-conectar-whatsapp');
    const btnDesconectar = document.getElementById('btn-desconectar-whatsapp');
    const statusText = document.getElementById('status-text');
    const statusIndicator = document.getElementById('status-indicator');
    const modalQrCode = document.getElementById('modalQrCode');
    const qrLoading = document.getElementById('qr-loading');
    const qrDisplay = document.getElementById('qr-code-display');
    const btnRefreshQr = document.getElementById('btn-refresh-qr');

    // Verificar status inicial
    verificarStatusWhatsApp();
    
    // Polling para verificar mudanças de status
    let statusPollingInterval = null;
    
    function iniciarPollingStatus() {
        if (statusPollingInterval) {
            clearInterval(statusPollingInterval);
        }
        
        statusPollingInterval = setInterval(async () => {
            try {
                // CHAMAR DIRETAMENTE O NODE.JS
                const response = await fetch(`${WHATSAPP_API_URL}/status`);
                if (response.ok) {
                    const data = await response.json();
                    // Verificar se há conexão para alguma empresa
                    const hasConnection = data.success && data.connections && Object.keys(data.connections).length > 0;
                    const empresaId = getCookie('empresa_id') || '365';
                    const connection = data.connections?.[empresaId];
                    
                    if (connection && connection.connected) {
                        // Conexão estabelecida - parar polling e atualizar UI
                        clearInterval(statusPollingInterval);
                        statusPollingInterval = null;
                        
                        // Fechar modal se estiver aberto
                        if (window.currentModal) {
                            window.currentModal.hide();
                        }
                        
                        // Atualizar status
                        statusText.textContent = 'Conectado';
                        statusIndicator.className = 'badge bg-success ms-2';
                        statusIndicator.textContent = 'Conectado';
                        btnConectar.style.display = 'none';
                        btnDesconectar.style.display = 'inline-block';
                        
                        // Mostrar notificação de sucesso
                        mostrarNotificacao('WhatsApp conectado com sucesso!', 'success');
                        
                        console.log('✅ WhatsApp conectado com sucesso!');
                    }
                }
            } catch (error) {
                console.error('Erro no polling de status:', error);
            }
        }, 2000); // Verificar a cada 2 segundos
    }
    
    function pararPollingStatus() {
        if (statusPollingInterval) {
            clearInterval(statusPollingInterval);
            statusPollingInterval = null;
        }
    }
    
function mostrarNotificacao(mensagem, tipo = 'info') {
    // Criar notificação Bootstrap
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${mensagem}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Remover automaticamente após 5 segundos
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Função para copiar URL de agendamento
function copiarUrlAgendamento() {
    const urlInput = document.getElementById('url_agendamento');
    const url = urlInput.value;
    
    // Tentar usar a API moderna de clipboard
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(url).then(() => {
            mostrarNotificacao('✅ URL copiada com sucesso!', 'success');
            
            // Atualizar o botão temporariamente
            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-check"></i> Copiado!';
            btn.classList.remove('btn-outline-secondary');
            btn.classList.add('btn-success');
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-secondary');
            }, 2000);
        }).catch(err => {
            console.error('Erro ao copiar:', err);
            fallbackCopyTextToClipboard(url);
        });
    } else {
        // Fallback para navegadores mais antigos
        fallbackCopyTextToClipboard(url);
    }
}

// Função fallback para copiar texto
function fallbackCopyTextToClipboard(text) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    textArea.style.top = "0";
    textArea.style.left = "0";
    textArea.style.position = "fixed";
    
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            mostrarNotificacao('✅ URL copiada com sucesso!', 'success');
            
            // Atualizar o botão temporariamente
            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-check"></i> Copiado!';
            btn.classList.remove('btn-outline-secondary');
            btn.classList.add('btn-success');
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-secondary');
            }, 2000);
        } else {
            mostrarNotificacao('❌ Erro ao copiar URL', 'error');
        }
    } catch (err) {
        console.error('Erro ao copiar:', err);
        mostrarNotificacao('❌ Erro ao copiar URL', 'error');
    }
    
    document.body.removeChild(textArea);
}

    // Event listeners
    btnConectar.addEventListener('click', conectarWhatsApp);
    btnDesconectar.addEventListener('click', desconectarWhatsApp);
    btnRefreshQr.addEventListener('click', atualizarQrCode);
    document.getElementById('btn-limpar-conexoes').addEventListener('click', limparConexoes);
    
    // Limpar referência do modal quando fechado
    modalQrCode.addEventListener('hidden.bs.modal', function () {
        window.currentModal = null;
    });

    // Verificar status a cada 5 segundos
    setInterval(verificarStatusWhatsApp, 5000);

    // Função para verificar status do WhatsApp
    async function verificarStatusWhatsApp() {
        try {
            // Obter ID da empresa
            let empresaId = getCookie('empresa_id') || 
                           localStorage.getItem('id_empresa') || 
                           getCookie('id_empresa') || 
                           document.querySelector('meta[name="empresa-id"]')?.getAttribute('content');
            
            if (!empresaId) {
                empresaId = '1'; // ID padrão para teste
            }
            
            console.log('🔍 Verificando status para empresa:', empresaId);
            // CHAMAR DIRETAMENTE O NODE.JS, NÃO O FLASK!
            const response = await fetch(`${WHATSAPP_API_URL}/status`);
            const data = await response.json();
            console.log('🔍 Status response do Node.js:', data);
            
            // Verificar se há conexão ativa para esta empresa
            if (data.success && data.connections) {
                const connection = data.connections[empresaId];
                console.log(`🔍 Conexão para empresa ${empresaId}:`, connection);
                
                if (connection && connection.connected) {
                    const userName = connection.user ? connection.user.name : 'Usuário';
                    statusText.textContent = `Conectado como: ${userName}`;
                    statusIndicator.className = 'badge bg-success ms-2';
                    statusIndicator.textContent = 'Conectado';
                    btnConectar.style.display = 'none';
                    btnDesconectar.style.display = 'inline-block';
                } else {
                    statusText.textContent = 'Desconectado';
                    statusIndicator.className = 'badge bg-danger ms-2';
                    statusIndicator.textContent = 'Desconectado';
                    btnConectar.style.display = 'inline-block';
                    btnDesconectar.style.display = 'none';
                }
            } else {
                statusText.textContent = 'Desconectado';
                statusIndicator.className = 'badge bg-danger ms-2';
                statusIndicator.textContent = 'Desconectado';
                btnConectar.style.display = 'inline-block';
                btnDesconectar.style.display = 'none';
            }
        } catch (error) {
            console.error('Erro ao verificar status:', error);
            statusText.textContent = 'Erro ao verificar status';
            statusIndicator.className = 'badge bg-warning ms-2';
            statusIndicator.textContent = 'Erro';
        }
    }

    // Função para conectar WhatsApp
    async function conectarWhatsApp() {
        try {
            // Obter ID da empresa de múltiplas fontes
            let empresaId = getCookie('empresa_id') || 
                           localStorage.getItem('id_empresa') || 
                           getCookie('id_empresa') || 
                           document.querySelector('meta[name="empresa-id"]')?.getAttribute('content');
            
            // Se ainda não encontrou, tentar obter via API
            if (!empresaId) {
                try {
                    const response = await fetch('/api/empresa/logada');
                    const data = await response.json();
                    if (data.id) {
                        empresaId = data.id;
                        localStorage.setItem('id_empresa', empresaId);
                    }
                } catch (e) {
                    console.warn('Não foi possível obter ID da empresa via API');
                }
            }
            
            // Fallback para ID padrão se ainda não encontrou
            if (!empresaId) {
                empresaId = '1'; // ID padrão para teste
                console.warn('Usando ID de empresa padrão:', empresaId);
            }
            
            console.log('🔍 DEBUG - ID da empresa:', empresaId);
            console.log('🔍 DEBUG - localStorage:', localStorage.getItem('id_empresa'));
            console.log('🔍 DEBUG - Cookie:', getCookie('id_empresa'));
            console.log('🔍 DEBUG - Meta tag:', document.querySelector('meta[name="empresa-id"]')?.getAttribute('content'));
            
            // Mostrar modal
            const modal = new bootstrap.Modal(modalQrCode);
            modal.show();
            
            // Armazenar referência do modal para uso posterior
            window.currentModal = modal;
            
            // Iniciar conexão
            console.log(`📞 Iniciando conexão para ${WHATSAPP_API_URL}/connect/${empresaId}`);
            const response = await fetch(`${WHATSAPP_API_URL}/connect/${empresaId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            console.log(`📊 Resposta do servidor:`, response.status, response.statusText);
            
            if (response.ok) {
                const data = await response.json();
                console.log(`✅ Conexão iniciada:`, data);
                
                // Aguardar QR Code
                aguardarQrCode(empresaId);
                
                // Iniciar polling para detectar conexão
                iniciarPollingStatus();
            } else {
                const errorData = await response.text();
                console.error(`❌ Erro na resposta:`, errorData);
                throw new Error(`Erro ao iniciar conexão: ${response.status} - ${errorData}`);
            }
        } catch (error) {
            console.error('❌ Erro ao conectar:', error);
            alert(`Erro ao conectar WhatsApp: ${error.message}\n\nVerifique se o servidor Baileys está rodando em ${WHATSAPP_API_URL}`);
        }
    }

    // Função para aguardar QR Code
    async function aguardarQrCode(empresaId) {
        console.log('Aguardando QR Code para empresa:', empresaId);
        qrLoading.style.display = 'block';
        qrDisplay.style.display = 'none';
        
        // Polling para verificar QR Code
        const interval = setInterval(async () => {
            try {
                console.log('Verificando QR Code para empresa:', empresaId);
                const response = await fetch(`${WHATSAPP_API_URL}/qr/${empresaId}`);
                const data = await response.json();
                
                console.log('Resposta do servidor QR:', data);
                
                if (data.qr) {
                    console.log('QR Code encontrado:', data.qr.substring(0, 50) + '...');
                    clearInterval(interval);
                    exibirQrCode(data.qr);
                } else if (data.connected) {
                    console.log('Conexão estabelecida');
                    clearInterval(interval);
                    if (window.currentModal) {
                        window.currentModal.hide();
                    }
                    verificarStatusWhatsApp();
                } else {
                    console.log('Aguardando QR Code...');
                }
            } catch (error) {
                console.error('Erro ao verificar QR Code:', error);
            }
        }, 2000);

        // Timeout após 60 segundos
        setTimeout(() => {
            clearInterval(interval);
            if (qrLoading.style.display !== 'none') {
                alert('Timeout ao gerar QR Code. Tente novamente.');
                if (window.currentModal) {
                    window.currentModal.hide();
                }
            }
        }, 60000);
    }

    // Função para exibir QR Code
    function exibirQrCode(qrData) {
        qrLoading.style.display = 'none';
        qrDisplay.style.display = 'block';
        
        console.log('🔍 DEBUG - QRCode disponível:', typeof QRCode);
        console.log('🔍 DEBUG - QR Data:', qrData);
        
        // Verificar se a biblioteca está carregada
        if (typeof QRCode === 'undefined') {
            console.error('❌ Biblioteca QRCode não carregada, usando fallback');
            // Fallback: usar API online para gerar QR Code
            qrDisplay.innerHTML = `
                <div class="text-center">
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=256x256&data=${encodeURIComponent(qrData)}" 
                         alt="QR Code" 
                         class="img-fluid border rounded"
                         style="max-width: 256px;">
                    <div class="mt-2">
                        <small class="text-muted">QR Code gerado via API externa</small>
                    </div>
                </div>
            `;
            return;
        }
        
        // Usar biblioteca QR Code
        qrDisplay.innerHTML = '';
        QRCode.toCanvas(qrDisplay, qrData, {
            width: 256,
            height: 256,
            color: {
                dark: '#000000',
                light: '#ffffff'
            },
            margin: 2,
            errorCorrectionLevel: 'M'
        }, function (error) {
            if (error) {
                console.error('Erro ao gerar QR Code:', error);
                qrDisplay.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>QR Code:</strong><br>
                        <code>${qrData}</code><br>
                        <small>Erro ao gerar QR Code visual</small>
                    </div>
                `;
            } else {
                console.log('✅ QR Code gerado com sucesso');
            }
        });
    }

    // Função para atualizar QR Code
    function atualizarQrCode() {
        // Obter ID da empresa
        let empresaId = getCookie('empresa_id') || 
                       localStorage.getItem('id_empresa') || 
                       getCookie('id_empresa') || 
                       document.querySelector('meta[name="empresa-id"]')?.getAttribute('content');
        
        if (!empresaId) {
            empresaId = '1'; // ID padrão para teste
        }
        
        aguardarQrCode(empresaId);
    }

    // Função para desconectar WhatsApp
    async function desconectarWhatsApp() {
        if (confirm('Tem certeza que deseja desconectar o WhatsApp?')) {
            try {
                // Obter ID da empresa
                let empresaId = getCookie('empresa_id') || 
                               localStorage.getItem('id_empresa') || 
                               getCookie('id_empresa') || 
                               document.querySelector('meta[name="empresa-id"]')?.getAttribute('content');
                
                if (!empresaId) {
                    empresaId = '1'; // ID padrão para teste
                }
                
                const response = await fetch(`${WHATSAPP_API_URL}/disconnect/${empresaId}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    pararPollingStatus();
                    // Aguardar um pouco para garantir que a desconexão foi processada
                    setTimeout(() => {
                        verificarStatusWhatsApp();
                        mostrarNotificacao('WhatsApp desconectado com sucesso!', 'info');
                    }, 1000);
                } else {
                    throw new Error('Erro ao desconectar');
                }
            } catch (error) {
                console.error('Erro ao desconectar:', error);
                alert('Erro ao desconectar WhatsApp.');
            }
        }
    }

    // Função para limpar todas as conexões
    async function limparConexoes() {
        if (confirm('Tem certeza que deseja limpar todas as conexões WhatsApp? Isso forçará uma nova autenticação.')) {
            try {
                const response = await fetch(`${WHATSAPP_API_URL}/clear-all`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    pararPollingStatus();
                    // Aguardar um pouco para garantir que a limpeza foi processada
                    setTimeout(() => {
                        verificarStatusWhatsApp();
                        mostrarNotificacao('Todas as conexões foram limpas! Agora você pode conectar novamente.', 'warning');
                    }, 1000);
                } else {
                    throw new Error('Erro ao limpar conexões');
                }
            } catch (error) {
                console.error('Erro ao limpar conexões:', error);
                alert('Erro ao limpar conexões WhatsApp.');
            }
        }
    }

    // Função auxiliar para obter cookie
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
    }

    // Debug completo dos cookies
    function debugCookies() {
        console.log('🍪 DEBUG - Todos os cookies:', document.cookie);
        console.log('🍪 DEBUG - empresa_id:', getCookie('empresa_id'));
        console.log('🍪 DEBUG - id_empresa:', getCookie('id_empresa'));
        console.log('🍪 DEBUG - localStorage id_empresa:', localStorage.getItem('id_empresa'));
        console.log('🍪 DEBUG - Meta tag empresa-id:', document.querySelector('meta[name="empresa-id"]')?.getAttribute('content'));
    }

    // Executar debug na inicialização
    debugCookies();
    
    // Verificar se QRCode está disponível
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🔍 DEBUG - QRCode após DOM carregado:', typeof QRCode);
        
        // Aguardar um pouco para garantir que todos os scripts carregaram
        setTimeout(function() {
            console.log('🔍 DEBUG - QRCode após timeout:', typeof QRCode);
            if (typeof QRCode === 'undefined') {
                console.warn('⚠️ QRCode não disponível, tentando recarregar...');
                // Tentar recarregar a biblioteca
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js';
                script.onload = function() {
                    console.log('✅ QRCode recarregado com sucesso');
                };
                script.onerror = function() {
                    console.error('❌ Falha ao recarregar QRCode');
                };
                document.head.appendChild(script);
            }
        }, 1000);
    });
});
</script>
{% endblock %}