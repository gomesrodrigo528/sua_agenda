{% extends "base.html" %}

{% block title %}Financeiro - Sua Agenda{% endblock %}

{% block content %}
<!-- Painel de Totais -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="text-center">
                            <h4>Total de Receitas</h4>
                            <h2 class="text-success" id="total-entradas">R$ 0,00</h2>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <h4>Total de Despesas</h4>
                            <h2 class="text-danger" id="total-saidas">R$ 0,00</h2>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <h4>Saldo</h4>
                            <h2 id="saldo">R$ 0,00</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Botões de Ação -->
<div class="row mb-4">
    <div class="col-12">
        <button class="btn btn-success me-2" onclick="$('#modalEntrada').modal('show')">
            <i class="bi bi-plus-circle"></i> Nova Entrada
        </button>
        <button class="btn btn-danger" onclick="$('#modalSaida').modal('show')">
            <i class="bi bi-dash-circle"></i> Nova Saída
        </button>
    </div>
</div>

<!-- Abas -->
<ul class="nav nav-tabs mb-4" id="financeiroTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="resumo-tab" data-bs-toggle="tab" data-bs-target="#resumo" type="button" role="tab">
            Resumo
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="entradas-tab" data-bs-toggle="tab" data-bs-target="#entradas" type="button" role="tab">
            Todas as Receitas
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="saidas-tab" data-bs-toggle="tab" data-bs-target="#saidas" type="button" role="tab">
            Todas as Despesas
        </button>
    </li>
</ul>

<!-- Conteúdo das Abas -->
<div class="tab-content" id="financeiroTabsContent">
    <!-- Aba de Resumo -->
    <div class="tab-pane fade show active" id="resumo" role="tabpanel">
        <div class="row">
            <!-- Últimas Entradas -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4 class="card-title">Últimas Receitas</h4>
                            <button class="btn btn-sm btn-outline-primary" onclick="$('#entradas-tab').tab('show')">
                                Ver Todas
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Motivo</th>
                                        <th>Valor</th>
                                        <th>Data</th>
                                    </tr>
                                </thead>
                                <tbody id="financeiro-body-ultimas-entradas">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Últimas Saídas -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4 class="card-title">Últimas Despesas</h4>
                            <button class="btn btn-sm btn-outline-primary" onclick="$('#saidas-tab').tab('show')">
                                Ver Todas
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Motivo</th>
                                        <th>Valor</th>
                                        <th>Data</th>
                                    </tr>
                                </thead>
                                <tbody id="financeiro-body-ultimas-saidas">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Aba de Todas as Receitas -->
    <div class="tab-pane fade" id="entradas" role="tabpanel">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <!-- Loading para Receitas -->
                    <div id="loading-receitas" class="text-center py-4" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                        <p class="mt-2 text-primary">Carregando receitas...</p>
                    </div>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Motivo</th>
                                <th>Cliente</th>
                                <th>Serviço</th>
                                <th>Valor</th>
                                <th>Meio de Pagamento</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="todas-entradas-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Aba de Todas as Despesas -->
    <div class="tab-pane fade" id="saidas" role="tabpanel">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <!-- Loading para Despesas -->
                    <div id="loading-despesas" class="text-center py-4" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                        <p class="mt-2 text-primary">Carregando despesas...</p>
                    </div>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Motivo</th>
                                <th>Valor</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="todas-saidas-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nova Entrada -->
<div class="modal fade" id="modalEntrada" tabindex="-1" aria-labelledby="modalEntradaLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalEntradaLabel">Nova Entrada</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formEntrada">
                    <div class="mb-3">
                        <label for="valor_entrada" class="form-label">Valor</label>
                        <input type="number" step="0.01" class="form-control" id="valor_entrada" required>
                    </div>
                    <div class="mb-3">
                        <label for="motivo_entrada" class="form-label">Motivo</label>
                        <input type="text" class="form-control" id="motivo_entrada" required>
                    </div>
                    <div class="mb-3">
                        <label for="meio_pagamento_entrada" class="form-label">Meio de Pagamento</label>
                        <select class="form-control" id="meio_pagamento_entrada" required>
                            <option value="dinheiro">Dinheiro</option>
                            <option value="pix">PIX</option>
                            <option value="credito">Cartão de Crédito</option>
                            <option value="debito">Cartão de Débito</option>
                        </select>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-success">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nova Saída -->
<div class="modal fade" id="modalSaida" tabindex="-1" aria-labelledby="modalSaidaLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalSaidaLabel">Nova Saída</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formSaida">
                    <div class="mb-3">
                        <label for="valor_saida" class="form-label">Valor</label>
                        <input type="number" step="0.01" class="form-control" id="valor_saida" required>
                    </div>
                    <div class="mb-3">
                        <label for="motivo_saida" class="form-label">Motivo</label>
                        <input type="text" class="form-control" id="motivo_saida" required>
                    </div>
                    <div class="mb-3">
                        <label for="meio_pagamento_saida" class="form-label">Meio de Pagamento</label>
                        <select class="form-control" id="meio_pagamento_saida" required>
                            <option value="dinheiro">Dinheiro</option>
                            <option value="pix">PIX</option>
                            <option value="credito">Cartão de Crédito</option>
                            <option value="debito">Cartão de Débito</option>
                        </select>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-danger">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal Detalhes da Entrada -->
<div class="modal fade" id="modalDetalhesEntrada" tabindex="-1" aria-labelledby="modalDetalhesEntradaLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalDetalhesEntradaLabel">Detalhes da Entrada</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="detalhe-id">
                <div class="mb-3">
                    <h6 class="fw-bold">Cliente</h6>
                    <p id="detalhe-cliente"></p>
                </div>
                <div class="mb-3">
                    <h6 class="fw-bold">Serviço</h6>
                    <p id="detalhe-servico"></p>
                </div>
                <div class="mb-3">
                    <h6 class="fw-bold">Motivo</h6>
                    <p id="detalhe-motivo"></p>
                </div>
                <div class="mb-3">
                    <h6 class="fw-bold">Valor</h6>
                    <p id="detalhe-valor"></p>
                </div>
                <div class="mb-3">
                    <h6 class="fw-bold">Meio de Pagamento</h6>
                    <p id="detalhe-pagamento"></p>
                </div>
                <div class="mb-3">
                    <h6 class="fw-bold">Data</h6>
                    <p id="detalhe-data"></p>
                </div>
                <div class="mb-3">
                    <h6 class="fw-bold">Usuário</h6>
                    <p id="detalhe-usuario"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-danger" onclick="excluirEntrada()">Excluir</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
// Função para formatar moeda
function formatarMoeda(valor) {
    return parseFloat(valor).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
}

// Função para carregar totais
async function carregarTotais() {
    try {
        const response = await fetch('/financeiro/totais');
        const data = await response.json();
        
        document.getElementById('total-entradas').textContent = formatarMoeda(data.total_entradas);
        document.getElementById('total-saidas').textContent = formatarMoeda(data.total_saidas);
        document.getElementById('saldo').textContent = formatarMoeda(data.total_entradas - data.total_saidas);
        
        // Aplica cor ao saldo
        const saldoElement = document.getElementById('saldo');
        if (data.total_entradas - data.total_saidas > 0) {
            saldoElement.classList.add('text-success');
            saldoElement.classList.remove('text-danger');
        } else {
            saldoElement.classList.add('text-danger');
            saldoElement.classList.remove('text-success');
        }
    } catch (err) {
        console.error('Erro ao carregar totais:', err);
    }
}

// Função para carregar últimas entradas
async function carregarUltimasEntradas() {
    try {
        const response = await fetch('/financeiro/ultimas_entradas');
        const entradas = await response.json();
        const tbody = document.getElementById('financeiro-body-ultimas-entradas');
        tbody.innerHTML = '';

        entradas.forEach(entrada => {
            const data = new Date(entrada.data);
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${entrada.motivo}</td>
                <td>${formatarMoeda(entrada.valor_entrada)}</td>
                <td>${data.toLocaleDateString('pt-BR')}</td>
            `;
            tr.style.cursor = 'pointer';
            tr.onclick = () => {
                // Armazena o ID da entrada para exclusão
                document.getElementById('detalhe-id').value = entrada.id;
                mostrarDetalhesEntrada(entrada);
            };
            tbody.appendChild(tr);
        });
    } catch (err) {
        console.error('Erro ao carregar últimas entradas:', err);
    }
}

// Função para carregar últimas saídas
async function carregarUltimasSaidas() {
    try {
        const response = await fetch('/financeiro/ultimas_saidas');
        const saidas = await response.json();
        const tbody = document.getElementById('financeiro-body-ultimas-saidas');
        tbody.innerHTML = '';

        saidas.forEach(saida => {
            const data = new Date(saida.data);
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${saida.motivo}</td>
                <td>${formatarMoeda(saida.valor_saida)}</td>
                <td>${data.toLocaleDateString('pt-BR')}</td>
            `;
            tbody.appendChild(tr);
        });
    } catch (err) {
        console.error('Erro ao carregar últimas saídas:', err);
    }
}

// Função para excluir entrada
async function excluirEntrada() {
    const id = document.getElementById('detalhe-id').value;
    if (!id) {
        alert('ID da receita não encontrado');
        return;
    }

    if (confirm('Tem certeza que deseja excluir esta receita?')) {
        try {
            const response = await fetch(`/financeiro/entrada/excluir/${id}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();

            if (response.ok) {
                $('#modalDetalhesEntrada').modal('hide');
                carregarTotais();
                carregarUltimasEntradas();
                carregarTodasEntradas();
                alert('Receita excluída com sucesso!');
            } else {
                alert(result.error || 'Erro ao excluir receita');
            }
        } catch (err) {
            console.error('ERRO:', err);
            alert('Erro ao excluir receita. Por favor, tente novamente.');
        }
    }
}

// Função para mostrar detalhes da entrada
function mostrarDetalhesEntrada(entrada) {
    try {
        // Armazena o ID para exclusão
        document.getElementById('detalhe-id').value = entrada.id_entrada;
        
        // Formata a data
        const dataObj = new Date(entrada.data || new Date());
        const dataFormatada = `${dataObj.toLocaleDateString('pt-BR')} às ${dataObj.toLocaleTimeString('pt-BR')}`;
        
        // Formata o valor
        const valorFormatado = typeof entrada.valor_entrada === 'number' ? 
            entrada.valor_entrada.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : 
            'R$ 0,00';

        // Preenche os campos do modal com tratamento para valores nulos
        document.getElementById('detalhe-cliente').textContent = entrada.cliente || 'Não informado';
        document.getElementById('detalhe-servico').textContent = entrada.servico || 'Não informado';
        document.getElementById('detalhe-motivo').textContent = entrada.motivo || 'Não informado';
        document.getElementById('detalhe-valor').textContent = valorFormatado;
        document.getElementById('detalhe-pagamento').textContent = entrada.meio_pagamento || 'Não informado';
        document.getElementById('detalhe-data').textContent = dataFormatada;
        document.getElementById('detalhe-usuario').textContent = entrada.usuario || 'Não informado';

        // Abre o modal
        $('#modalDetalhesEntrada').modal('show');
    } catch (err) {
        console.error('Erro ao mostrar detalhes da entrada:', err);
        alert('Erro ao exibir detalhes da receita. Por favor, tente novamente.');
    }
}

// Configuração dos formulários
document.getElementById('formEntrada').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const dados = {
        valor: parseFloat(document.getElementById('valor_entrada').value),
        motivo: document.getElementById('motivo_entrada').value,
        meio_pagamento: document.getElementById('meio_pagamento_entrada').value
    };

    try {
        const response = await fetch('/financeiro/entrada', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(dados)
        });

        const result = await response.json();

        if (response.ok) {
            $('#modalEntrada').modal('hide');
            document.getElementById('formEntrada').reset();
            carregarTotais();
            carregarUltimasEntradas();
            alert('Receita registrada com sucesso!');
        } else {
            alert(Array.isArray(result.error) ? result.error.join('\n') : result.error);
        }
    } catch (err) {
        console.error('Erro ao registrar receita:', err);
        alert('Erro ao registrar receita.');
    }
});

document.getElementById('formSaida').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const dados = {
        valor: parseFloat(document.getElementById('valor_saida').value),
        motivo: document.getElementById('motivo_saida').value,
        meio_pagamento: document.getElementById('meio_pagamento_saida').value
    };

    try {
        const response = await fetch('/financeiro/saida', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(dados)
        });

        const result = await response.json();

        if (response.ok) {
            $('#modalSaida').modal('hide');
            document.getElementById('formSaida').reset();
            carregarTotais();
            carregarUltimasSaidas();
            alert('Despesa registrada com sucesso!');
        } else {
            alert(Array.isArray(result.error) ? result.error.join('\n') : result.error);
        }
    } catch (err) {
        console.error('Erro ao registrar despesa:', err);
        alert('Erro ao registrar despesa.');
    }
});

// Função para carregar todas as receitas
async function carregarTodasEntradas() {
    try {
        // Mostra o loading
        document.getElementById('loading-receitas').style.display = 'block';
        document.getElementById('todas-entradas-body').innerHTML = '';

        const response = await fetch('/financeiro/listar');
        const data = await response.json();
        const tbody = document.getElementById('todas-entradas-body');

        data.entradas.forEach(entrada => {
            const data = new Date(entrada.data);
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${data.toLocaleDateString('pt-BR')}</td>
                <td>${entrada.motivo}</td>
                <td>${entrada.cliente}</td>
                <td>${entrada.servico}</td>
                <td>${formatarMoeda(entrada.valor_entrada)}</td>
                <td>${entrada.meio_pagamento}</td>
                <td>
                    <button class="btn btn-sm btn-info" onclick='mostrarDetalhesEntrada(${JSON.stringify(entrada)})'>
                        <i class="bi bi-eye"></i> Detalhes
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    } catch (err) {
        console.error('Erro ao carregar todas as receitas:', err);
        document.getElementById('todas-entradas-body').innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-danger">
                    Erro ao carregar receitas. Por favor, tente novamente.
                </td>
            </tr>
        `;
    } finally {
        // Esconde o loading
        document.getElementById('loading-receitas').style.display = 'none';
    }
}

// Função para carregar todas as despesas
async function carregarTodasSaidas() {
    try {
        // Mostra o loading
        document.getElementById('loading-despesas').style.display = 'block';
        document.getElementById('todas-saidas-body').innerHTML = '';

        const response = await fetch('/financeiro/listar');
        const data = await response.json();
        const tbody = document.getElementById('todas-saidas-body');

        data.saidas.forEach(saida => {
            const data = new Date(saida.data);
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${data.toLocaleDateString('pt-BR')}</td>
                <td>${saida.motivo}</td>
                <td>${formatarMoeda(saida.valor_saida)}</td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="excluirSaida(${saida.id})">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    } catch (err) {
        console.error('Erro ao carregar todas as despesas:', err);
        document.getElementById('todas-saidas-body').innerHTML = `
            <tr>
                <td colspan="4" class="text-center text-danger">
                    Erro ao carregar despesas. Por favor, tente novamente.
                </td>
            </tr>
        `;
    } finally {
        // Esconde o loading
        document.getElementById('loading-despesas').style.display = 'none';
    }
}

// Evento para carregar dados quando trocar de aba
document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(tab => {
    tab.addEventListener('shown.bs.tab', function (e) {
        if (e.target.id === 'entradas-tab') {
            carregarTodasEntradas();
        } else if (e.target.id === 'saidas-tab') {
            carregarTodasSaidas();
        }
    });
});

// Carregar dados quando a página carregar
document.addEventListener('DOMContentLoaded', () => {
    carregarTotais();
    carregarUltimasEntradas();
    carregarUltimasSaidas();
});
</script>
{% endblock %}