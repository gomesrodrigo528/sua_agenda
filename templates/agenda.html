{% extends "base.html" %}

{% block title %}Agenda - Sua Agenda{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/styles/agenda.css">
<link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
<meta name="theme-color" content="#ffffff">
<link rel="icon" href="/static/img/icone-mobile.png">
    
    <!-- Estilos para Popups -->
    <style>
        /* Tela de carregamento - Ultra máxima prioridade */
        #loading-screen {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background-color: rgba(0, 0, 0, 0.9) !important;
            justify-content: center !important;
            align-items: center !important;
            z-index: 999999 !important;
            flex-direction: column !important;
        }
        
        /* Quando visível, usar display flex */
        #loading-screen[style*="flex"] {
            display: flex !important;
        }
        
        #loading-screen .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        #loading-screen p {
            color: white;
            font-size: 18px;
            font-weight: 500;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .popup-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out;
        }
        
        .popup-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }
        
        .popup-icon.success {
            color: #28a745;
        }
        
        .popup-icon.error {
            color: #dc3545;
        }
        
        .popup-icon.warning {
            color: #ffc107;
        }
        
        .popup-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }
        
        .popup-message {
            font-size: 16px;
            color: #666;
            margin-bottom: 25px;
            line-height: 1.5;
        }
        
        .popup-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .popup-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 100px;
        }
        
        .popup-btn.primary {
            background-color: #007bff;
            color: white;
        }
        
        .popup-btn.primary:hover {
            background-color: #0056b3;
        }
        
        .popup-btn.secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .popup-btn.secondary:hover {
            background-color: #545b62;
        }
        
        .popup-btn.success {
            background-color: #28a745;
            color: white;
        }
        
        .popup-btn.success:hover {
            background-color: #1e7e34;
        }
        
        .popup-btn.danger {
            background-color: #dc3545;
            color: white;
        }
        
        .popup-btn.danger:hover {
            background-color: #c82333;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { 
                opacity: 0;
                transform: translateY(-20px) scale(0.9);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .popup-overlay.fade-out {
            animation: fadeOut 0.3s ease-in-out;
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        /* Estilos para busca com dropdown */
        .dropdown-item:hover {
            background-color: #f8f9fa;
        }
        
        .dropdown-item:active {
            background-color: #e9ecef;
        }
        
        .form-control-lg {
            font-size: 1.1rem;
            padding: 0.75rem 1rem;
        }
        
        .form-select-lg {
            font-size: 1.1rem;
            padding: 0.75rem 1rem;
        }
        
        .modal-md {
            max-width: 500px;
        }
        
        @media (max-width: 768px) {
            .modal-md {
                max-width: 95%;
                margin: 10px auto;
            }
        }
        
        /* Modal deve sobrepor tudo EXCETO tela de carregamento */
        #agendamentoModal {
            z-index: 9998 !important;
        }
        
        #agendamentoModal .modal-dialog {
            z-index: 9999 !important;
        }
        
        #agendamentoModal .modal-content {
            z-index: 10000 !important;
        }
        
        /* Backdrop do modal */
        .modal-backdrop {
            z-index: 9997 !important;
        }
        
        /* Modal de detalhes do agendamento - Máxima prioridade */
        #agendamentoDetalhesModal {
            z-index: 10010 !important;
        }
        
        #agendamentoDetalhesModal .modal-dialog {
            z-index: 10011 !important;
        }
        
        #agendamentoDetalhesModal .modal-content {
            z-index: 10012 !important;
        }
        
        /* Modal de pagamento - Alta prioridade */
        #pagamentoModal {
            z-index: 10005 !important;
        }
        
        #pagamentoModal .modal-dialog {
            z-index: 10006 !important;
        }
        
        #pagamentoModal .modal-content {
            z-index: 10007 !important;
        }
        
        /* Modal de mensagem - Média prioridade */
        #modalMensagem {
            z-index: 10003 !important;
        }
        
        #modalMensagem .modal-dialog {
            z-index: 10004 !important;
        }
        
        #modalMensagem .modal-content {
            z-index: 10005 !important;
        }
        
        /* Modais de cadastro - Média prioridade */
        #addServiceModal, #addClienteModal {
            z-index: 10001 !important;
        }
        
        #addServiceModal .modal-dialog, #addClienteModal .modal-dialog {
            z-index: 10002 !important;
        }
        
        #addServiceModal .modal-content, #addClienteModal .modal-content {
            z-index: 10003 !important;
        }
        
        .fw-bold {
            font-weight: 600 !important;
        }
        
        .position-relative .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            z-index: 1000;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
    </style>
{% endblock %}

{% block content %}

    <div id="loading-screen" style="display: none;">
        <div class="spinner"></div>
        <p>Processando agendamento...</p>
    </div>



    <!-- Modal de Notificações - REMOVIDO (agora usando barra superior) -->

    <!-- Modal Global de Mensagens -->
    <div class="modal fade" id="modalMensagem" tabindex="-1" aria-labelledby="modalMensagemLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalMensagemLabel">Mensagem</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="modalMensagemBody">
                    <!-- Conteúdo da mensagem será inserido aqui -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Conteúdo Principal da Agenda -->

            <!-- Botão para exibir o formulário - REMOVIDO -->



            <!-- Botão para abrir o modal -->




            <!-- Modal para exibir detalhes do agendamento -->
            <div class="modal fade" id="agendamentoDetalhesModal" tabindex="-1"
                aria-labelledby="agendamentoDetalhesModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="modal-title">Detalhes do Agendamento</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body" id="modal-body">
                            <!-- Detalhes do agendamento serão exibidos aqui -->
                        </div>
                    </div>
                </div>
            </div>


            <!-- Modal de Agendamento -->
            <div class="modal fade" id="agendamentoModal" tabindex="-1" aria-labelledby="agendamentoModalLabel"
                aria-hidden="true">
                <div class="modal-dialog modal-md">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title" id="agendamentoModalLabel">
                                <i class="bi bi-calendar-plus me-2"></i>Novo Agendamento
                            </h5>
                            <button type="button" class="btn-close btn-close-white" onclick="fecharModalAgendamento()" aria-label="Close"></button>
                        </div>
                        <div class="modal-body p-3">
                            <form id="form-agendamento" class="needs-validation" novalidate>
                                <!-- Cliente -->
                                <div class="mb-3">
                                    <label for="cliente-busca" class="form-label fw-bold">
                                        <i class="bi bi-person me-1"></i>Cliente
                                    </label>
                                    <div class="position-relative">
                                        <input type="text" id="cliente-busca" class="form-control" 
                                               placeholder="Digite o nome do cliente..." 
                                               autocomplete="off">
                                        <div id="cliente-dropdown" class="dropdown-menu w-100" style="max-height: 200px; overflow-y: auto; display: none;">
                                            <!-- Opções carregadas dinamicamente -->
                                        </div>
                                        <input type="hidden" id="cliente-id" name="cliente_id">
                                    </div>
                                    <div class="d-flex justify-content-between mt-2">
                                        <small class="text-muted">Digite o nome do cliente para buscar</small>
                                        <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addClienteModal">
                                            <i class="bi bi-person-plus me-1"></i>Novo Cliente
                                        </button>
                                    </div>
                                </div>

                                <!-- Serviço -->
                                <div class="mb-3">
                                    <label for="servico-busca" class="form-label fw-bold">
                                        <i class="bi bi-briefcase me-1"></i>Serviço
                                    </label>
                                    <div class="position-relative">
                                        <input type="text" id="servico-busca" class="form-control" 
                                               placeholder="Digite o nome do serviço..." 
                                               autocomplete="off">
                                        <div id="servico-dropdown" class="dropdown-menu w-100" style="max-height: 200px; overflow-y: auto; display: none;">
                                            <!-- Opções carregadas dinamicamente -->
                                        </div>
                                        <input type="hidden" id="servico-id" name="servico_id">
                                    </div>
                                    <div class="d-flex justify-content-between mt-2">
                                        <small class="text-muted">Digite para buscar serviços</small>
                                        <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addServiceModal">
                                            <i class="bi bi-plus-circle me-1"></i>Novo Serviço
                                        </button>
                                    </div>
                                </div>

                                <!-- Profissional -->
                                <div class="mb-3">
                                    <label for="usuario-agendamento" class="form-label fw-bold">
                                        <i class="bi bi-person-badge me-1"></i>Profissional
                                    </label>
                                    <select id="usuario-agendamento" class="form-select" required>
                                        <option value="">Selecione um profissional</option>
                                    </select>
                                </div>

                                <!-- Data e Horário -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="data-agendamento" class="form-label fw-bold">
                                            <i class="bi bi-calendar-event me-1"></i>Data
                                        </label>
                                        <input type="date" id="data-agendamento" class="form-control" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="hora-agendamento" class="form-label fw-bold">
                                            <i class="bi bi-clock me-1"></i>Horário
                                        </label>
                                        <input type="time" id="hora-agendamento" class="form-control" required>
                                    </div>
                                </div>

                                <!-- Descrição -->
                                <div class="mb-3">
                                    <label for="descricao-agendamento" class="form-label fw-bold">
                                        <i class="bi bi-chat-text me-1"></i>Descrição
                                    </label>
                                    <textarea id="descricao-agendamento" name="descricao" class="form-control" rows="2"
                                        placeholder="Adicione detalhes sobre o compromisso..."></textarea>
                                </div>

                                <!-- Botões -->
                                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                    <button type="button" class="btn btn-outline-secondary me-md-2" onclick="fecharModalAgendamento()">
                                        <i class="bi bi-x-circle me-1"></i>Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-success">
                                        <i class="bi bi-check-circle me-1"></i>Agendar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>


            <div class="modal fade" id="pagamentoModal" tabindex="-1" aria-labelledby="pagamentoModalLabel"
                aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="pagamentoModalLabel">Informações de Pagamento</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body" id="modal-pagamento-body">
                            <!-- Conteúdo gerado dinamicamente -->
                        </div>
                    </div>
                </div>
            </div>


            <!-- Botão para atualizar agenda -->
            <div class="mb-3 d-flex gap-2 justify-content-center">
                <button id="btnRefreshAgenda" class="btn btn-outline-success" type="button" title="Atualizar dados">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>

            <div id="calendar-container">
                <div id="calendar"></div>
            </div>

            <div id="list-container" style="box-shadow:transparent; background-color:transparent; border: none;">
                <!-- Filtro moderno -->
                <div class="filter-container">
                    <select id="filter">
                        <option value="day">📅 Hoje</option>
                        <option value="week">📆 Semana</option>
                        <option value="month">🗓️ Mês</option>
                    </select>
                </div>
                
                <!-- Lista de agendamentos -->
                <ul id="appointment-list"></ul>
                
                <!-- Botão flutuante para novo agendamento (mobile) - REMOVIDO -->
            </div>

    <!-- Modal -->
    <div class="modal fade" id="addServiceModal" tabindex="-1" aria-labelledby="addServiceModalLabel"
    aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">

        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addServiceModalLabel">Cadastrar Serviço</h5>
                   
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>

                </div>
                <div class="modal-body">
                    <form method="POST" action="/add_service">
                        <div class="mb-3">
                            <label for="nome_servico" class="form-label">Nome do Serviço</label>
                            <input type="text" class="form-control" id="nome_servico" name="nome_servico" required>
                        </div>
                        <div class="mb-3">
                            <label for="preco" class="form-label">Preço (R$)</label>
                            <input type="number" step="0.01" class="form-control" id="preco" name="preco" required>
                        </div>
                        <div class="mb-3">
                            <label for="tempo" class="form-label">Tempo Estimado (minutos)</label>
                            <input type="number" class="form-control" id="tempo" name="tempo" required>
                        </div>
                        <div class="mb-3">
                            <label for="responsavel" class="form-label">Responsável pelo Serviço</label>
                            <select name="responsavel" id="responsavel" class="form-control">
                                <option value="" disabled selected>Selecione o responsável</option>
                                <!-- Adicione as opções dinamicamente aqui -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <input type="checkbox" class="form-check-input" id="disp_cliente" name="disp_cliente"
                                value="1" required checked>
                            <label class="form-check-label" for="disp_cliente">Disponível para os clientes</label>
                        </div>
                        <button type="submit" class="btn btn-success">Cadastrar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <!-- Modal -->
    <div class="modal fade" id="addClienteModal" tabindex="-1" aria-labelledby="addClienteModalLabel"
    aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">

        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addClienteModalLabel">Cadastrar Cliente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="POST" action="/add_cliente">
                        <div class="mb-3">
                            <label for="nome" class="form-label">Nome</label>
                            <input type="text" class="form-control" id="nome" name="nome"
                                placeholder="Digite o nome do cliente" required>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">E-mail</label>
                            <input type="email" class="form-control" id="email" name="email"
                                placeholder="Digite o e-mail do cliente" required>
                        </div>
                        <div class="mb-3">
                            <label for="telefone" class="form-label">Telefone</label>
                            <input type="number" class="form-control" id="telefone" name="telefone"
                                placeholder="Digite o telefone do cliente" required>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-success">Cadastrar</button>
                            <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap CSS and JS (necessário para o modal funcionar) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
    // Listener para o formulário de cadastro de clientes
    document.querySelector("#addClienteModal form").addEventListener("submit", function (event) {
        event.preventDefault(); // Evita o recarregamento da página

        let formData = new FormData(this);

        fetch("/add_cliente", {
            method: "POST",
            body: formData
        })
        .then(response => response.json()) // Espera o JSON de resposta
        .then(data => {
            if (data.message) {
                console.log("Sucesso:", data.message);

                // Fecha o modal de cliente
                let modal = bootstrap.Modal.getInstance(document.getElementById("addClienteModal"));
                modal.hide();

                // Limpa os campos do formulário
                event.target.reset();

                // Exibe uma mensagem de sucesso
                mostrarMensagem("Sucesso", data.message);
            } else {
                console.error("Erro:", data.error);
                mostrarMensagem("Erro", "Erro ao cadastrar cliente: " + data.error);
            }
        })
        .catch(error => {
            console.error("Erro na requisição:", error);
            mostrarMensagem("Erro", "Erro ao cadastrar cliente");
        });
    });
});
document.addEventListener("DOMContentLoaded", function () {
    // Listener para o formulário de cadastro de serviços
    document.querySelector("#addServiceModal form").addEventListener("submit", function (event) {
        event.preventDefault(); // Evita o recarregamento da página

        let formData = new FormData(this);

        fetch("/add_service", {
            method: "POST",
            body: formData
        })
        .then(response => response.json()) // Espera o JSON de resposta
        .then(data => {
            if (data.message) {
                console.log("Sucesso:", data.message);

                // Fecha o modal de serviço
                let modal = bootstrap.Modal.getInstance(document.getElementById("addServiceModal"));
                modal.hide();

                // Limpa os campos do formulário
                event.target.reset();

                // Exibe uma mensagem de sucesso
                mostrarMensagem(data.message, "Sucesso");
            } else if (data.error) {
                console.error("Erro:", data.error);
                mostrarMensagem(data.error, "Erro");
            }
        })
        .catch(error => {
            console.error("Erro na requisição:", error);
            mostrarMensagem("Erro ao cadastrar serviço", "Erro");
        });
    });
});

// Função para mostrar mensagens em pop-up
function mostrarMensagem(titulo, mensagem, tipo = 'info') {
    // Criar modal dinamicamente se não existir
    let modal = document.getElementById('modalMensagem');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'modalMensagem';
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalMensagemLabel">${titulo}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                    </div>
                    <div class="modal-body">
                        <p id="modalMensagemBody">${mensagem}</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    } else {
        document.getElementById('modalMensagemLabel').textContent = titulo;
        document.getElementById('modalMensagemBody').textContent = mensagem;
    }
    
    // Ajustar cor do modal baseado no tipo
    const modalContent = modal.querySelector('.modal-content');
    modalContent.className = 'modal-content';
    if (tipo === 'success') {
        modalContent.classList.add('border-success');
    } else if (tipo === 'error') {
        modalContent.classList.add('border-danger');
    }
    
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
}

    </script>
    
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const agendamentoModal = document.getElementById("agendamentoModal");
    
            // Impede que o modal principal seja fechado
            agendamentoModal.addEventListener("hide.bs.modal", function (event) {
                event.preventDefault(); // Evita o fechamento
            });
    
            document.querySelectorAll(".modal").forEach((modal) => {
                modal.addEventListener("shown.bs.modal", function () {
                    let modaisAbertos = document.querySelectorAll(".modal.show").length;
                    this.style.zIndex = 1050 + (modaisAbertos * 10);
                    
                    // Mantém o backdrop abaixo do modal principal
                    let backdrops = document.querySelectorAll(".modal-backdrop");
                    backdrops.forEach((backdrop) => {
                        backdrop.style.zIndex = 1040;
                    });
                });
    
                modal.addEventListener("hidden.bs.modal", function () {
                    // Se ainda houver modais abertos, mantém a classe modal-open no body
                    if (document.querySelectorAll(".modal.show").length > 0) {
                        document.body.classList.add("modal-open");
                    } else {
                        // Se o agendamentoModal ainda está visível, forçamos a reabertura
                        if (agendamentoModal.classList.contains("show")) {
                            document.body.classList.add("modal-open");
                        }
                    }
                });
            });
        });
    </script>
    
    <!-- Script de notificações removido - agora usando barra superior -->


    <script src="static/scripts/agenda.js"></script>
    <script src="static/scripts/busca_agendamento.js"></script>
    <!-- Bootstrap JS e Dependências -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>
    <!-- Biblioteca FullCalendar -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <!-- JS Personalizado -->
    <script src="static/scripts/menu.js"></script>
    <script>
        // Adiciona fallback para ocultar loading após 15 segundos
        setTimeout(() => {
            const loading = document.getElementById('loading-screen');
            if (loading && loading.style.display !== 'none') {
                console.warn('Fallback: Ocultando loading após timeout');
                loading.style.display = 'none';
            }
        }, 15000);
    </script>
    <script src="static/scripts/script.js"></script>

    <script>
        // Função para abrir o modal de agendamento
        function abrirModalAgendamento() {
            const modal = new bootstrap.Modal(document.getElementById('agendamentoModal'));
            modal.show();
        }
        
        fetch('/api/usuarios')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erro na requisição: ${response.status} - ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                const usuarioSelect = document.getElementById('responsavel');
                if (usuarioSelect) {
                    data.forEach(usuario => {
                        const option = document.createElement('option');
                        option.value = usuario.id;
                        option.textContent = usuario.nome_usuario;
                        usuarioSelect.appendChild(option);
                    });
                } else {
                    console.error('Elemento select com ID "responsavel" não encontrado.');
                }
            })
            .catch(error => {
                console.error('Erro ao buscar ou processar os usuários:', error.message);
            });

    </script>

    <!-- Botão flutuante de novo agendamento -->
    <style>
    #btn-agendamento-flutuante {
        position: fixed;
        bottom: 32px;
        right: 32px;
        z-index: 9999;
        background: linear-gradient(135deg, #007bff 80%, #0056b3 100%);
        border: none;
        outline: none;
        cursor: pointer;
        box-shadow: 0 4px 16px rgba(0,0,0,0.18);
        border-radius: 50%;
        width: 64px;
        height: 64px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: box-shadow 0.2s, transform 0.2s;
    }
    #btn-agendamento-flutuante:hover {
        box-shadow: 0 8px 32px rgba(0,0,0,0.28);
        transform: scale(1.08);
    }
    #btn-agendamento-flutuante .icone {
        color: #fff;
        font-size: 2.2rem;
        font-weight: bold;
        text-shadow: 0 2px 8px rgba(0,0,0,0.18);
        line-height: 1;
    }
    </style>
    <button id="btn-agendamento-flutuante" onclick="abrirModalAgendamento()" title="Novo Agendamento">
        <i class="bi bi-calendar-plus icone"></i>
    </button>

    <!-- Popup de Sucesso -->
    <div id="popup-success" class="popup-overlay">
        <div class="popup-content">
            <div class="popup-icon success">
                <i class="bi bi-check-circle-fill"></i>
            </div>
            <div class="popup-title">Sucesso!</div>
            <div class="popup-message" id="popup-success-message"></div>
            <div class="popup-buttons">
                <button class="popup-btn success" onclick="fecharPopup('popup-success')">OK</button>
            </div>
        </div>
    </div>

    <!-- Popup de Erro -->
    <div id="popup-error" class="popup-overlay">
        <div class="popup-content">
            <div class="popup-icon error">
                <i class="bi bi-x-circle-fill"></i>
            </div>
            <div class="popup-title">Erro</div>
            <div class="popup-message" id="popup-error-message"></div>
            <div class="popup-buttons">
                <button class="popup-btn danger" onclick="fecharPopup('popup-error')">OK</button>
            </div>
        </div>
    </div>

    <!-- Popup de Confirmação -->
    <div id="popup-confirm" class="popup-overlay">
        <div class="popup-content">
            <div class="popup-icon warning">
                <i class="bi bi-exclamation-triangle-fill"></i>
            </div>
            <div class="popup-title">Confirmar</div>
            <div class="popup-message" id="popup-confirm-message"></div>
            <div class="popup-buttons">
                <button class="popup-btn secondary" onclick="fecharPopup('popup-confirm')">Cancelar</button>
                <button class="popup-btn danger" id="popup-confirm-btn">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Popup de Aviso -->
    <div id="popup-warning" class="popup-overlay">
        <div class="popup-content">
            <div class="popup-icon warning">
                <i class="bi bi-exclamation-circle-fill"></i>
            </div>
            <div class="popup-title">Aviso</div>
            <div class="popup-message" id="popup-warning-message"></div>
            <div class="popup-buttons">
                <button class="popup-btn primary" onclick="fecharPopup('popup-warning')">OK</button>
            </div>
        </div>
    </div>

    <script src="/static/scripts/push_register.js"></script>
{% endblock %}

{% block page_scripts %}
    <script src="static/scripts/agenda.js"></script>
    <script src="static/scripts/busca_agendamento.js"></script>
    <!-- Biblioteca FullCalendar -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <script>
        // Adiciona fallback para ocultar loading após 15 segundos
        setTimeout(() => {
            const loading = document.getElementById('loading-screen');
            if (loading && loading.style.display !== 'none') {
                console.warn('Fallback: Ocultando loading após timeout');
                loading.style.display = 'none';
            }
        }, 15000);
    </script>
{% endblock %}